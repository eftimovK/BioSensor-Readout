/*
*********************************************************************************************************
*                                       EXAMPLE CODE
*
*               This file is provided as an example on how to use Micrium products.
*
*               Please feel free to use any application code labeled as 'EXAMPLE CODE' in
*               your application products.  Example code may be used as is, in whole or in
*               part, or may be used as a reference only. This file can be modified as
*               required to meet the end-product requirements.
*
*               Please help us continue to provide the Embedded community with the finest
*               software available.  Your honesty is greatly appreciated.
*
*               You can find our product's user manual, API reference, release notes and
*               more information at: https://doc.micrium.com
*
*               You can contact us at: http://www.micrium.com
*
*               Portions Copyright (c) 2014 Analog Devices, Inc.
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*
*                           USB DEVICE MSC CLASS APPLICATION INITIALIZATION
*
*                                              TEMPLATE
*
* Filename      : app_usbd_msc.c
* Version       : V4.04.01
* Programmer(s) : FT
*********************************************************************************************************
*/


/*
*********************************************************************************************************
*                                              INCLUDE FILES
*********************************************************************************************************
*/

#include  <app_usbd.h>

#if (APP_CFG_USBD_MSC_EN == DEF_ENABLED)

#include  <usbd_msc.h>
#include <usbd_cfg.h>
#include <includes.h>
#include <usbd_storage.h>
#include <startup.h>

/*
*********************************************************************************************************
*                                              LOCAL DEFINES
*********************************************************************************************************
*/
//#define __RDONLY_RAMDISK__
#define  USBD_RAMDISK_SIZE       (USBD_RAMDISK_CFG_BLK_SIZE * \
                                  USBD_RAMDISK_CFG_NBR_BLKS)

#if defined ( __ICCARM__ )
    #pragma data_alignment=4  /* IAR */
#elif defined (__CC_ARM)
    __align(4)                /* Keil */
#else
    #pragma message("WARNING: NO ALIGHMENT DEFINED FOR IVT RELOCATION")
#endif
//SECTION_PLACE(KEEP_VAR(__no_init uint8_t __RAMDisk[USBD_RAMDISK_SIZE]), USBD_RAMDISK_CFG_BASE_ADDR);
        //;
#ifndef __RDONLY_RAMDISK__
SECTION_PLACE(KEEP_VAR( uint8_t __RAMDisk[USBD_RAMDISK_SIZE]), USBD_RAMDISK_CFG_BASE_ADDR);
#else
SECTION_PLACE(KEEP_VAR(const uint8_t __RAMDisk[USBD_RAMDISK_SIZE]), USBD_RAMDISK_CFG_BASE_ADDR) = {
    0xeb,  0x3c,  0x90,  0x4d,  0x53,  0x44,  0x4f,  0x53,  0x35,  0x2e,  0x30,  0x00,  0x02,  0x01,  0x01,  0x00,
    0x01,  0x20,  0x00,  0x20,  0x00,  0xf8,  0x0c,  0x00,  0x3f,  0x00,  0xff,  0x00,  0x00,  0x00,  0x00,  0x00,
    0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0x29,  0x29,  0x5c,  0x66,  0x88,  0x4e,  0x4f,  0x20,  0x4e,  0x41,
    0x4d,  0x45,  0x20,  0x20,  0x20,  0x20,  0x46,  0x41,  0x54,  0x31,  0x32,  0x20,  0x20,  0x20,  0x33,  0xc9,
    0x8e,  0xd1,  0xbc,  0xf0,  0x7b,  0x8e,  0xd9,  0xb8,  0x00,  0x20,  0x8e,  0xc0,  0xfc,  0xbd,  0x00,  0x7c,
    0x38,  0x4e,  0x24,  0x7d,  0x24,  0x8b,  0xc1,  0x99,  0xe8,  0x3c,  0x01,  0x72,  0x1c,  0x83,  0xeb,  0x3a,
    0x66,  0xa1,  0x1c,  0x7c,  0x26,  0x66,  0x3b,  0x07,  0x26,  0x8a,  0x57,  0xfc,  0x75,  0x06,  0x80,  0xca,
    0x02,  0x88,  0x56,  0x02,  0x80,  0xc3,  0x10,  0x73,  0xeb,  0x33,  0xc9,  0x8a,  0x46,  0x10,  0x98,  0xf7,
    0x66,  0x16,  0x03,  0x46,  0x1c,  0x13,  0x56,  0x1e,  0x03,  0x46,  0x0e,  0x13,  0xd1,  0x8b,  0x76,  0x11,
    0x60,  0x89,  0x46,  0xfc,  0x89,  0x56,  0xfe,  0xb8,  0x20,  0x00,  0xf7,  0xe6,  0x8b,  0x5e,  0x0b,  0x03,
    0xc3,  0x48,  0xf7,  0xf3,  0x01,  0x46,  0xfc,  0x11,  0x4e,  0xfe,  0x61,  0xbf,  0x00,  0x00,  0xe8,  0xe6,
    0x00,  0x72,  0x39,  0x26,  0x38,  0x2d,  0x74,  0x17,  0x60,  0xb1,  0x0b,  0xbe,  0xa1,  0x7d,  0xf3,  0xa6,
    0x61,  0x74,  0x32,  0x4e,  0x74,  0x09,  0x83,  0xc7,  0x20,  0x3b,  0xfb,  0x72,  0xe6,  0xeb,  0xdc,  0xa0,
    0xfb,  0x7d,  0xb4,  0x7d,  0x8b,  0xf0,  0xac,  0x98,  0x40,  0x74,  0x0c,  0x48,  0x74,  0x13,  0xb4,  0x0e,
    0xbb,  0x07,  0x00,  0xcd,  0x10,  0xeb,  0xef,  0xa0,  0xfd,  0x7d,  0xeb,  0xe6,  0xa0,  0xfc,  0x7d,  0xeb,
    0xe1,  0xcd,  0x16,  0xcd,  0x19,  0x26,  0x8b,  0x55,  0x1a,  0x52,  0xb0,  0x01,  0xbb,  0x00,  0x00,  0xe8,
    0x3b,  0x00,  0x72,  0xe8,  0x5b,  0x8a,  0x56,  0x24,  0xbe,  0x0b,  0x7c,  0x8b,  0xfc,  0xc7,  0x46,  0xf0,
    0x3d,  0x7d,  0xc7,  0x46,  0xf4,  0x29,  0x7d,  0x8c,  0xd9,  0x89,  0x4e,  0xf2,  0x89,  0x4e,  0xf6,  0xc6,
    0x06,  0x96,  0x7d,  0xcb,  0xea,  0x03,  0x00,  0x00,  0x20,  0x0f,  0xb6,  0xc8,  0x66,  0x8b,  0x46,  0xf8,
    0x66,  0x03,  0x46,  0x1c,  0x66,  0x8b,  0xd0,  0x66,  0xc1,  0xea,  0x10,  0xeb,  0x5e,  0x0f,  0xb6,  0xc8,
    0x4a,  0x4a,  0x8a,  0x46,  0x0d,  0x32,  0xe4,  0xf7,  0xe2,  0x03,  0x46,  0xfc,  0x13,  0x56,  0xfe,  0xeb,
    0x4a,  0x52,  0x50,  0x06,  0x53,  0x6a,  0x01,  0x6a,  0x10,  0x91,  0x8b,  0x46,  0x18,  0x96,  0x92,  0x33,
    0xd2,  0xf7,  0xf6,  0x91,  0xf7,  0xf6,  0x42,  0x87,  0xca,  0xf7,  0x76,  0x1a,  0x8a,  0xf2,  0x8a,  0xe8,
    0xc0,  0xcc,  0x02,  0x0a,  0xcc,  0xb8,  0x01,  0x02,  0x80,  0x7e,  0x02,  0x0e,  0x75,  0x04,  0xb4,  0x42,
    0x8b,  0xf4,  0x8a,  0x56,  0x24,  0xcd,  0x13,  0x61,  0x61,  0x72,  0x0b,  0x40,  0x75,  0x01,  0x42,  0x03,
    0x5e,  0x0b,  0x49,  0x75,  0x06,  0xf8,  0xc3,  0x41,  0xbb,  0x00,  0x00,  0x60,  0x66,  0x6a,  0x00,  0xeb,
    0xb0,  0x4e,  0x54,  0x4c,  0x44,  0x52,  0x20,  0x20,  0x20,  0x20,  0x20,  0x20,  0x0d,  0x0a,  0x52,  0x65,
    0x6d,  0x6f,  0x76,  0x65,  0x20,  0x64,  0x69,  0x73,  0x6b,  0x73,  0x20,  0x6f,  0x72,  0x20,  0x6f,  0x74,
    0x68,  0x65,  0x72,  0x20,  0x6d,  0x65,  0x64,  0x69,  0x61,  0x2e,  0xff,  0x0d,  0x0a,  0x44,  0x69,  0x73,
    0x6b,  0x20,  0x65,  0x72,  0x72,  0x6f,  0x72,  0xff,  0x0d,  0x0a,  0x50,  0x72,  0x65,  0x73,  0x73,  0x20,
    0x61,  0x6e,  0x79,  0x20,  0x6b,  0x65,  0x79,  0x20,  0x74,  0x6f,  0x20,  0x72,  0x65,  0x73,  0x74,  0x61,
    0x72,  0x74,  0x0d,  0x0a,  0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0xac,  0xcb,  0xd8,  0x55,  0xaa
};
#endif




/*
*********************************************************************************************************
*                                            LOCAL DATA TYPES
*********************************************************************************************************
*/

typedef struct {
    CPU_INT08U msc_dev_nbr;
    CPU_INT08U *pRAMDisk;
} ADI_USBD_RAMDISK_DEF;

/*
*********************************************************************************************************
*                                              LOCAL TABLES
*********************************************************************************************************
*/
#ifndef __RDONLY_RAMDISK__
static  const CPU_INT08U  RAMDISK_BootRecord[512] = {
    0xeb,  0x3c,  0x90,  0x4d,  0x53,  0x44,  0x4f,  0x53,  0x35,  0x2e,  0x30,  0x00,  0x02,  0x01,  0x01,  0x00,
    0x01,  0x20,  0x00,  0x20,  0x00,  0xf8,  0x0c,  0x00,  0x3f,  0x00,  0xff,  0x00,  0x00,  0x00,  0x00,  0x00,
    0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0x29,  0x29,  0x5c,  0x66,  0x88,  0x4e,  0x4f,  0x20,  0x4e,  0x41,
    0x4d,  0x45,  0x20,  0x20,  0x20,  0x20,  0x46,  0x41,  0x54,  0x31,  0x32,  0x20,  0x20,  0x20,  0x33,  0xc9,
    0x8e,  0xd1,  0xbc,  0xf0,  0x7b,  0x8e,  0xd9,  0xb8,  0x00,  0x20,  0x8e,  0xc0,  0xfc,  0xbd,  0x00,  0x7c,
    0x38,  0x4e,  0x24,  0x7d,  0x24,  0x8b,  0xc1,  0x99,  0xe8,  0x3c,  0x01,  0x72,  0x1c,  0x83,  0xeb,  0x3a,
    0x66,  0xa1,  0x1c,  0x7c,  0x26,  0x66,  0x3b,  0x07,  0x26,  0x8a,  0x57,  0xfc,  0x75,  0x06,  0x80,  0xca,
    0x02,  0x88,  0x56,  0x02,  0x80,  0xc3,  0x10,  0x73,  0xeb,  0x33,  0xc9,  0x8a,  0x46,  0x10,  0x98,  0xf7,
    0x66,  0x16,  0x03,  0x46,  0x1c,  0x13,  0x56,  0x1e,  0x03,  0x46,  0x0e,  0x13,  0xd1,  0x8b,  0x76,  0x11,
    0x60,  0x89,  0x46,  0xfc,  0x89,  0x56,  0xfe,  0xb8,  0x20,  0x00,  0xf7,  0xe6,  0x8b,  0x5e,  0x0b,  0x03,
    0xc3,  0x48,  0xf7,  0xf3,  0x01,  0x46,  0xfc,  0x11,  0x4e,  0xfe,  0x61,  0xbf,  0x00,  0x00,  0xe8,  0xe6,
    0x00,  0x72,  0x39,  0x26,  0x38,  0x2d,  0x74,  0x17,  0x60,  0xb1,  0x0b,  0xbe,  0xa1,  0x7d,  0xf3,  0xa6,
    0x61,  0x74,  0x32,  0x4e,  0x74,  0x09,  0x83,  0xc7,  0x20,  0x3b,  0xfb,  0x72,  0xe6,  0xeb,  0xdc,  0xa0,
    0xfb,  0x7d,  0xb4,  0x7d,  0x8b,  0xf0,  0xac,  0x98,  0x40,  0x74,  0x0c,  0x48,  0x74,  0x13,  0xb4,  0x0e,
    0xbb,  0x07,  0x00,  0xcd,  0x10,  0xeb,  0xef,  0xa0,  0xfd,  0x7d,  0xeb,  0xe6,  0xa0,  0xfc,  0x7d,  0xeb,
    0xe1,  0xcd,  0x16,  0xcd,  0x19,  0x26,  0x8b,  0x55,  0x1a,  0x52,  0xb0,  0x01,  0xbb,  0x00,  0x00,  0xe8,
    0x3b,  0x00,  0x72,  0xe8,  0x5b,  0x8a,  0x56,  0x24,  0xbe,  0x0b,  0x7c,  0x8b,  0xfc,  0xc7,  0x46,  0xf0,
    0x3d,  0x7d,  0xc7,  0x46,  0xf4,  0x29,  0x7d,  0x8c,  0xd9,  0x89,  0x4e,  0xf2,  0x89,  0x4e,  0xf6,  0xc6,
    0x06,  0x96,  0x7d,  0xcb,  0xea,  0x03,  0x00,  0x00,  0x20,  0x0f,  0xb6,  0xc8,  0x66,  0x8b,  0x46,  0xf8,
    0x66,  0x03,  0x46,  0x1c,  0x66,  0x8b,  0xd0,  0x66,  0xc1,  0xea,  0x10,  0xeb,  0x5e,  0x0f,  0xb6,  0xc8,
    0x4a,  0x4a,  0x8a,  0x46,  0x0d,  0x32,  0xe4,  0xf7,  0xe2,  0x03,  0x46,  0xfc,  0x13,  0x56,  0xfe,  0xeb,
    0x4a,  0x52,  0x50,  0x06,  0x53,  0x6a,  0x01,  0x6a,  0x10,  0x91,  0x8b,  0x46,  0x18,  0x96,  0x92,  0x33,
    0xd2,  0xf7,  0xf6,  0x91,  0xf7,  0xf6,  0x42,  0x87,  0xca,  0xf7,  0x76,  0x1a,  0x8a,  0xf2,  0x8a,  0xe8,
    0xc0,  0xcc,  0x02,  0x0a,  0xcc,  0xb8,  0x01,  0x02,  0x80,  0x7e,  0x02,  0x0e,  0x75,  0x04,  0xb4,  0x42,
    0x8b,  0xf4,  0x8a,  0x56,  0x24,  0xcd,  0x13,  0x61,  0x61,  0x72,  0x0b,  0x40,  0x75,  0x01,  0x42,  0x03,
    0x5e,  0x0b,  0x49,  0x75,  0x06,  0xf8,  0xc3,  0x41,  0xbb,  0x00,  0x00,  0x60,  0x66,  0x6a,  0x00,  0xeb,
    0xb0,  0x4e,  0x54,  0x4c,  0x44,  0x52,  0x20,  0x20,  0x20,  0x20,  0x20,  0x20,  0x0d,  0x0a,  0x52,  0x65,
    0x6d,  0x6f,  0x76,  0x65,  0x20,  0x64,  0x69,  0x73,  0x6b,  0x73,  0x20,  0x6f,  0x72,  0x20,  0x6f,  0x74,
    0x68,  0x65,  0x72,  0x20,  0x6d,  0x65,  0x64,  0x69,  0x61,  0x2e,  0xff,  0x0d,  0x0a,  0x44,  0x69,  0x73,
    0x6b,  0x20,  0x65,  0x72,  0x72,  0x6f,  0x72,  0xff,  0x0d,  0x0a,  0x50,  0x72,  0x65,  0x73,  0x73,  0x20,
    0x61,  0x6e,  0x79,  0x20,  0x6b,  0x65,  0x79,  0x20,  0x74,  0x6f,  0x20,  0x72,  0x65,  0x73,  0x74,  0x61,
    0x72,  0x74,  0x0d,  0x0a,  0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0x00,  0xac,  0xcb,  0xd8,  0x55,  0xaa
};
#endif
/*
*********************************************************************************************************
*                                         LOCAL GLOBAL VARIABLES
*********************************************************************************************************
*/

//static  OS_STK   DiskPrep_TaskStartStk[APP_CFG_TASK_START_STK_SIZE];

/*
*********************************************************************************************************
*                                        LOCAL FUNCTION PROTOTYPES
*********************************************************************************************************
*/
//static void  DiskPrep_Task(void *p_arg);
static void AdjustFatBootSector( CPU_INT08U *pBootRecordData, CPU_INT32U nVolumeSize );
static void DiskPrep_Function(CPU_INT08U msc_dev_nbr, CPU_INT08U *pRAMDisk);


/*
*********************************************************************************************************
*                                       LOCAL CONFIGURATION ERRORS
*********************************************************************************************************
*/


/*
*********************************************************************************************************
*                                         App_USBD_MSC_Init()
*
* Description : Initialize USB device mass storage class.
*
* Argument(s) : p_dev     Pointer to USB device.
*
*               cfg_hs      Index of high-speed configuration to which this interface will be added to.
*
*               cfg_fs      Index of high-speed configuration to which this interface will be added to.
*
* Return(s)   : DEF_OK,    if the Mass storage interface was added.
*               DEF_FAIL,  if the Mass storage interface could not be added.
*
* Caller(s)   : App_USBD_Init().
*
* Note(s)     : none.
*********************************************************************************************************
*/
static CPU_INT08U    msc_nbr;

CPU_BOOLEAN   App_USBD_MSC_Init (CPU_INT08U  dev_nbr,
                                 CPU_INT08U  cfg_hs,
                                 CPU_INT08U  cfg_fs)
{
    USBD_ERR      err;
    CPU_BOOLEAN   valid;

    APP_TRACE_DBG(("        Initializing MSC class ... \r\n"));

    USBD_MSC_Init(&err);
    if (err != USBD_ERR_NONE) {
        APP_TRACE_DBG(("        ... could not initialize MSC class w/err = %d\r\n\r\n", err));
        return (DEF_FAIL);
    }

    msc_nbr = USBD_MSC_Add(&err);

    if (cfg_hs != USBD_CFG_NBR_NONE) {
        valid = USBD_MSC_CfgAdd (msc_nbr,
                                 dev_nbr,
                                 cfg_hs,
                                 &err);

        if (valid != DEF_YES) {
            APP_TRACE_DBG(("        ... could not add msc instance #%d to HS configuration w/err = %d\r\n\r\n", msc_nbr, err));
            return (DEF_FAIL);
        }
    }

    if (cfg_fs != USBD_CFG_NBR_NONE) {
        valid = USBD_MSC_CfgAdd (msc_nbr,
                                dev_nbr,
                                cfg_fs,
				&err);

        if (valid != DEF_YES) {
            APP_TRACE_DBG(("        ... could not add msc instance #%d to FS configuration w/err = %d\r\n\r\n", msc_nbr, err));
            return (DEF_FAIL);
        }
    }

    USBD_MSC_LunAdd((void *)"ram:0:",
                             msc_nbr,                           /* Add Logical Unit to MSC interface                    */
                    (void *)"Micrium",
                    (void *)"MSC FS Storage",
                             0x00,
                             USBD_RAMDISK_CFG_RDONLY,
                            &err);
    if (err != USBD_ERR_NONE) {
        APP_TRACE_DBG(("        ... could not add LU to MSC class w/err = %d\r\n\r\n", err));
        return (DEF_FAIL);
    }

    DiskPrep_Function(dev_nbr, (CPU_INT08U *)USBD_RAMDISK_CFG_BASE_ADDR);

    return (DEF_OK);
}
#if 0
/*********************************************************************

	Function:		Create_RAMDiskPrepareTask

	Description:	Creates UCOS-II task to initialize RAMDisk

*********************************************************************/
void Create_RAMDiskPrepareTask( CPU_INT08U msc_dev_nbr )
{
    static ADI_USBD_RAMDISK_DEF RAMDiskDef;
    RAMDiskDef.msc_dev_nbr = msc_dev_nbr;
    RAMDiskDef.pRAMDisk = (CPU_INT08U *)USBD_RAMDISK_CFG_BASE_ADDR;

	OSTaskCreate( DiskPrep_Task,
                  (void *)&RAMDiskDef,
                  &DiskPrep_TaskStartStk[0],
                  APP_CFG_DISKPREP_TASK_PRIO
                );

}
#endif


/*********************************************************************

	Function:		AdjustFatBootSector

	Description:	Routine to adjust the total sector count in the
	                RAM Disk boot sector.

*********************************************************************/
static void AdjustFatBootSector( CPU_INT08U *pBootRecordData, CPU_INT32U nVolumeSize )
{

    CPU_INT08U *pBPB_SecPerClus = (CPU_INT08U*)&pBootRecordData[13];
    CPU_INT08U *pBPB_NumFATs = (CPU_INT08U*)&pBootRecordData[16];

    CPU_INT08U *pBPB_ResvdSecCnt_LSB = (CPU_INT08U*)&pBootRecordData[14];
    CPU_INT08U *pBPB_ResvdSecCnt_MSB = (CPU_INT08U*)&pBootRecordData[15];

    CPU_INT08U *pBPB_RootEntCnt_LSB = (CPU_INT08U*)&pBootRecordData[17];
    CPU_INT08U *pBPB_RootEntCnt_MSB = (CPU_INT08U*)&pBootRecordData[18];

    CPU_INT08U *pBPB_HiddSec = (CPU_INT08U*)&pBootRecordData[28];

    CPU_INT08U *pBPB_TotSec16_LSB = (CPU_INT08U*)&pBootRecordData[19];
    CPU_INT08U *pBPB_TotSec16_MSB = (CPU_INT08U*)&pBootRecordData[20];

    CPU_INT08U *pBPB_BytsPerSec_LSB = (CPU_INT08U*)&pBootRecordData[11];
    CPU_INT08U *pBPB_BytsPerSec_MSB = (CPU_INT08U*)&pBootRecordData[12];

    CPU_INT16U BPB_BytsPerSec = (*pBPB_BytsPerSec_LSB) | ((*pBPB_BytsPerSec_MSB)<<8);
    CPU_INT16U BPB_TotSec16 = nVolumeSize/BPB_BytsPerSec;

    *pBPB_SecPerClus = 1;

    *pBPB_NumFATs = (CPU_INT08U)1;
    *pBPB_HiddSec = 0;

    *pBPB_ResvdSecCnt_LSB = 1;
    *pBPB_ResvdSecCnt_MSB = 0;

    *pBPB_RootEntCnt_LSB = 0x20;
    *pBPB_RootEntCnt_MSB = 0x00;

    *pBPB_TotSec16_LSB = (CPU_INT08U)(BPB_TotSec16&0x00FF);
    *pBPB_TotSec16_MSB = (CPU_INT08U)((BPB_TotSec16&0xFF00)>>8);

}

/* Set disk prep time. the max appears to be between 3500 and 4000
*/
static void DiskPrep_Function(CPU_INT08U msc_dev_nbr, CPU_INT08U *pRAMDisk)
{
#ifndef __RDONLY_RAMDISK__
    /*
     * Copy boot record as above
    */
	Mem_Copy( (void*)pRAMDisk, RAMDISK_BootRecord, 512 );

	/*
     * Now modify the default settings above:
	 *
	 *  BPB_NumFATs     = 0x01     - 1 FAT
	 *  BPB_HiddSec     = 0x00     - No hidden sectors
	 *  BPB_ResvdSecCnt = 0x0001   - 1 reserved sector count
	 *  BPB_RootEntCnt  = 0x0020   - 32 root directory entries
	 *  BPB_TotSec16    = USBD_RAMDISK_SIZE (see usbd_cfg.h)
	 *  BPB_SecPerClus  = 0x01     - 1 sector per cluster
	 */
    AdjustFatBootSector( pRAMDisk, USBD_RAMDISK_SIZE);
#endif
}
#if 0
static  void  DiskPrep_Task(void *p_arg)
{
    ADI_USBD_RAMDISK_DEF *pRAMDiskDef = (ADI_USBD_RAMDISK_DEF *)p_arg;
    CPU_INT08U *pRAMDisk = pRAMDiskDef->pRAMDisk;
    CPU_INT08U msc_dev_nbr = pRAMDiskDef->msc_dev_nbr;

    DiskPrep_Function( msc_dev_nbr, pRAMDisk );

    /* delay to simulate further preparation of the RAM disk
    */
    int delay = 0x007FFFFF;
    for (; delay>0;delay--);

    App_USBD_DevStart(msc_dev_nbr);

    /* delete task */
    OSTaskDel(APP_CFG_DISKPREP_TASK_PRIO);
}
#endif
#endif

/*********************************************************************************

Copyright (c) 2012-2014 Analog Devices, Inc. All Rights Reserved.

This software is proprietary to Analog Devices, Inc. and its licensors.  By using 
this software you agree to the terms of the associated Analog Devices Software 
License Agreement.

*********************************************************************************/

/*****************************************************************************
 * @file:    Captouch_AwakeTest.c
 * @brief:   CT Test for ADuCM350
 * @version: $Revision: 29206 $
 * @date:    $Date: 2014-12-12 09:23:10 -0500 (Fri, 12 Dec 2014) $
 *****************************************************************************/

/*! \addtogroup CT_Test CT Test
 *  .
 *  @{
 */

/*!
 * @brief       Function 'main' for Captouch_AwakeTest example program
 *
 * @param       none
 * @return      int (Zero for success, non-zero for failure).
 *
 * @details     Simple application that configures the Captouch to wake up the Cortex
 *              from Core and System Sleep Mode. One single button is configured (Up Button).
 *             
 *
 */

/* Apply ADI MISRA Suppressions */
#define ASSERT_ADI_MISRA_SUPPRESSIONS


#include <stddef.h>		/* for 'NULL' */
#include <string.h>		/* for strlen */

#include "test_common.h"

#include "captouch.h"
#include "captouch_lib.h"

#define CT_CORTEX_INTERRUPT_MASK       0x00400000


/* CT device Handle */
ADI_CT_DEV_HANDLE hDevice = NULL;
uint8_t  CaptouchEvents;

/* prototypes */
extern int32_t adi_initpinmux (void);
void ct_AutoCAPDAC_adjust(ADI_CT_DEV_HANDLE const hCaptouchDevice);

void ctCallback (void *pCBParam, uint32_t status, void *pArg);

volatile bool_t                 bCommonInterruptFlag;

int main(void)
{
    /* callbacks */
    ADI_CT_INTERRUPT_TYPE callbacks = (ADI_CT_INTERRUPT_TYPE)
                                      ADI_CT_INTERRUPT_TOUCH_DETECTED;

    uint8_t ButtonStatus;

    /* Initialize system */
    SystemInit();

    /* initialize the test console */
    test_Init();

    SetSystemClockDivider(ADI_SYS_CLOCK_CORE, 1);
    
    adi_initpinmux();

    /* Initialize the CT API */
    if (adi_CT_Init(ADI_CT_DEV_ID_0,&hDevice)) {
        FAIL("Init");
    }

    /* Configure the Captouch */
    ct_AutoCAPDAC_adjust(hDevice);

    /* register callback handler for CT interrupts */
    adi_CT_RegisterCallback(hDevice, ctCallback, callbacks);

    /* Power Up the Captouch  */
    if(adi_CT_SetPowerStatus(hDevice,true)){
        FAIL("Power UP");
    }

    /* START THE EXAMPLE */

    PERF("Start the Test: CAPTOUCH WAKE UP TEST\n");
    PERF("Cortex in CORE Sleep Mode: Press UP Button\n");

    /* Send Cortex to sleep in Core Sleep mode */
    bCommonInterruptFlag = false;
    SystemEnterLowPowerMode(ADI_SYS_MODE_CORE_SLEEP, &bCommonInterruptFlag, 0);

    /* Check if the event was generated by the Captouch*/
    if(!(pADI_NVIC->INTSTA & CT_CORTEX_INTERRUPT_MASK))
    {
      FAIL("No Captouch Interrupt");
    }

    /* Check if a Touch Event happened */
       if(CaptouchEvents & ADI_CT_INTERRUPT_TOUCH_DETECTED)
    {
        /* TOUCH EVENT */

        /* Look up and clear which register generated the Touch Event */
        adi_CT_GetTchAndRelAlgorithmStatus(hDevice,&ButtonStatus);

        PERF("AWAKE!\n");
        PERF("Cortex in SYSTEM Sleep Mode: Press UP Button\n");

        for(uint16_t wait = 0; wait < 1000 ; wait++); // little delay to be sure that the message is sent before starting the sleep mode

        bCommonInterruptFlag = false;
        SystemEnterLowPowerMode(ADI_SYS_MODE_SYS_SLEEP, &bCommonInterruptFlag, 0);

        /* Check if the event was generated by the Captouch*/
        if(!(pADI_NVIC->INTSTA & CT_CORTEX_INTERRUPT_MASK))
        {
          FAIL("No Captouch Interrupt");
        }

        /* Check if a Touch Event happened */
       if(CaptouchEvents & ADI_CT_INTERRUPT_TOUCH_DETECTED)
       {
          /* TOUCH EVENT */

          /* Look up and clear which register generated the Touch Event */
          adi_CT_GetTchAndRelAlgorithmStatus(hDevice,&ButtonStatus);

          PERF("AWAKE!\n");
          PASS();

        }

        else
        {
          FAIL("No Touched Captouch Interrupt");
        }

     }

    else
    {
      FAIL("No Touched Captouch Interrupt");
    }

}




void ct_AutoCAPDAC_adjust(ADI_CT_DEV_HANDLE const hCaptouchDevice)

{

  /* AUTO CAPDAC ADJUSTMENT*/

  adi_CT_Stage_AutoCAPDAC_Adjustment(hCaptouchDevice,ADI_CT_STAGE1_NUMBER,ADI_CT_DEFAULT_BASELINE_VALUE);

  adi_CT_SetAutoForceBaselineCal(hCaptouchDevice);

}


/* Callback handler */
void ctCallback (void *pCBParam,uint32_t status, void *pArg) {

    SystemExitLowPowerMode(&bCommonInterruptFlag);

    /* process CT interrupts (cleared by driver) */

    if ((ADI_CT_INTERRUPT_TOUCH_DETECTED) & status) {
        CaptouchEvents=status;
        adi_CT_ClearInterruptFlag(hDevice);
    }

}



/* Revert ADI MISRA Suppressions */
#define REVERT_ADI_MISRA_SUPPRESSIONS
#include "misra.h"

/*
** EOF
*/

/*@}*/
